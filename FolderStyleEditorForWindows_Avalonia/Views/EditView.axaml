<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
            xmlns:vm="using:FolderStyleEditorForWindows.ViewModels"
            xmlns:services="using:FolderStyleEditorForWindows.Services"
            xmlns:i="using:Avalonia.Xaml.Interactivity"
            xmlns:ia="using:Avalonia.Xaml.Interactions.Animated"
            xmlns:sys="using:System"
            mc:Ignorable="d" d:DesignWidth="404" d:DesignHeight="762"
            x:Class="FolderStyleEditorForWindows.Views.EditView"
            x:DataType="vm:MainViewModel">
   <UserControl.Resources>
        <DataTemplate x:Key="IconDataTemplate" x:DataType="vm:IconViewModel">
            <Border Classes="IcoCell" BorderThickness="1" BorderBrush="{StaticResource LineBrush}"
                    Background="{Binding IsSelected, Converter={StaticResource BoolToBrushConverter}, ConverterParameter='SelectedBrush'}"
                    Width="48" Height="48">
                <ToolTip.Tip>
                    <TextBlock Text="{Binding Index, StringFormat='索引: {0}'}"/>
                </ToolTip.Tip>
                <Grid RowDefinitions="*,Auto" Margin="2">
                    <Image Source="{Binding Image}" Grid.Row="0" Width="32" Height="32" Margin="4"/>
                    <TextBlock Text="{Binding Index}" Grid.Row="1" FontSize="10" HorizontalAlignment="Center" Foreground="{StaticResource Fg3Brush}"/>
                </Grid>
            </Border>
        </DataTemplate>
    </UserControl.Resources>
   <Grid>
        <!-- Title Bar -->
        <DockPanel VerticalAlignment="Top" Height="54">
            <Grid ColumnDefinitions="Auto,*,Auto" Margin="12,0">
               <Border Width="38" Height="28" CornerRadius="10" Background="Transparent" BoxShadow="{StaticResource Shadow1}" Padding="0" VerticalAlignment="Center">
                   <Button Name="btnBack" Grid.Column="0" Classes="TitleBarButton TitleBarButtonHover" Padding="0" Width="38" Height="28">
                       <Path Data="{StaticResource BackIcon}" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,0,9,6"/>
                   </Button>
               </Border>
               <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Title]}" Grid.Column="0" Grid.ColumnSpan="3" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="{StaticResource Fg1Brush}" Opacity="0.8" FontSize="16" FontWeight="SemiBold" IsHitTestVisible="False"/>
                  <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                   <Border Width="38" Height="28" CornerRadius="10" Background="Transparent" BoxShadow="{StaticResource Shadow1}" Padding="0" VerticalAlignment="Center">
                       <Button Name="btnMin" Classes="TitleBarButton TitleBarButtonHover" Padding="0" Width="38" Height="28">
                           <Path Data="{StaticResource MinimizeIcon}" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,0,4,12"/>
                       </Button>
                   </Border>
                   <Border Width="38" Height="28" CornerRadius="10" Background="Transparent" BoxShadow="{StaticResource Shadow1}" Padding="0" VerticalAlignment="Center">
                       <Button Name="btnClose" Classes="TitleBarButton TitleBarButtonHover" Padding="0" Width="38" Height="28">
                           <Path Data="{StaticResource CloseIcon}" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="0,0,5,4.6"/>
                       </Button>
                   </Border>
                </StackPanel>
            </Grid>
        </DockPanel>

        <!-- Main Scrollable Content -->
     <ScrollViewer Margin="0,54,0,0">
         <i:Interaction.Behaviors>
             <ia:VerticalScrollViewerAnimatedBehavior/>
         </i:Interaction.Behaviors>
         <StackPanel Spacing="8" Margin="12,12,12,120">
             
             <!-- Directory Card -->
                <Border Classes="Card">
                    <StackPanel Spacing="10">
                     <Grid ColumnDefinitions="*,Auto">
                         <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Directory_Title]}" Classes="Subtitle" VerticalAlignment="Center"/>
                         <Button Name="btnOpenExplorer" Content="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Directory_OpenExplorer]}" Classes="BtnGhost" Grid.Column="1" Margin="0,2,0,0"/>
                     </Grid>
                     <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                         <TextBox Name="pathInput" Text="{Binding FolderPath}" Grid.Column="0" Watermark="C:\Users\Me\Pictures" Classes="Input"/>
                         <Button Name="btnPickDir" Grid.Column="1" Classes="Btn">
                               <StackPanel Orientation="Horizontal" Spacing="8">
                                   <PathIcon Data="M3 7h5l2 2h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/>
                                   <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Directory_Select]}"/>
                               </StackPanel>
                           </Button>
                       </Grid>
                       <TextBlock Name="pathError" Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Directory_Invalid]}" Classes="ErrorTip"/>
                    </StackPanel>
                </Border>

                <!-- Drag Tip -->
                <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_DragTip]}" Classes="Note" HorizontalAlignment="Center" Margin="0,10,0,8"/>

                <!-- Info Card -->
                <Border Classes="Card">
                    <StackPanel Spacing="10">
                        <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Info_Title]}" Classes="Subtitle"/>
                        <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Alias_Label]}" Classes="Body"/>
                        <TextBox Name="aliasInput" Text="{Binding Alias}" Watermark="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Alias_Watermark]}" Classes="Input"
                                 Classes.placeholder="{Binding IsAliasAsPlaceholder}">
                            <TextBox.Styles>
                                <Style Selector="TextBox.Input.placeholder">
                                    <Setter Property="Foreground" Value="{StaticResource Fg3Brush}"/>
                                </Style>
                            </TextBox.Styles>
                        </TextBox>

                        <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Icon_Label]}" Classes="Body" Margin="0,14,0,0"/>
                        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                            <TextBox Name="iconInput" Text="{Binding IconPath}" Watermark="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Icon_Watermark]}" Grid.Column="0" Classes="Input"/>
                            <Button Name="btnPickIcon" Grid.Column="1" Classes="Btn">
                                <StackPanel Orientation="Horizontal" Spacing="8">
                                    <PathIcon Data="M3 7h5l2 2h11v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/>
                                    <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Icon_Select]}"/>
                                </StackPanel>
                            </Button>
                        </Grid>

                        <Border Classes="IconPicker" Margin="0,10,0,0">
                            <Grid>
                                <ScrollViewer HorizontalScrollBarVisibility="Disabled" VerticalScrollBarVisibility="Auto" Height="182">
                                    <i:Interaction.Behaviors>
                                        <ia:VerticalScrollViewerAnimatedBehavior/>
                                    </i:Interaction.Behaviors>
                                    <ListBox ItemsSource="{Binding Icons}"
                                             ItemTemplate="{StaticResource IconDataTemplate}"
                                             SelectedItem="{Binding SelectedIcon, Mode=TwoWay}"
                                             Background="Transparent"
                                             BorderThickness="0">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal" />
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                    </ListBox>
                                </ScrollViewer>

                                <!-- 加载指示器 -->
                                <ProgressBar IsIndeterminate="True"
                                             IsVisible="{Binding IsLoadingIcons}"
                                             VerticalAlignment="Center"
                                             HorizontalAlignment="Stretch"
                                             Margin="20,0"/>
                                <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Icon_Loading]}"
                                           IsVisible="{Binding IsLoadingIcons}"
                                           VerticalAlignment="Center"
                                           HorizontalAlignment="Center"
                                           Foreground="{StaticResource Fg2Brush}"
                                           Margin="0,30,0,0"/>
                            </Grid>
                        </Border>
                        <Grid ColumnDefinitions="*,Auto,Auto" ColumnSpacing="12" Margin="0,12,0,0">
                           <!-- 保留了原有的重置图标按钮 -->
                           <Button Name="btnResetIcon" Content="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Icon_Reset]}" Classes="Btn" Grid.Column="0" Command="{Binding ResetIconCommand}"/>
                           
                           <!-- 新增的“自动获取图标”按钮 -->
                           <Button Name="btnAutoGetIcon" Content="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Icon_AutoGet]}" Classes="Btn" Grid.Column="1" Command="{Binding AutoGetIconCommand}"/>
                           
                           <!-- 新增的、用于显示 "1/5" 这种计数的文本 -->
                           <TextBlock Text="{Binding IconCounterText}"
                                      IsVisible="{Binding IsIconCounterVisible}"
                                      VerticalAlignment="Center"
                                      HorizontalAlignment="Right"
                                      Grid.Column="2"
                                      Foreground="{StaticResource Fg2Brush}"
                                      FontWeight="SemiBold"/>
                       </Grid>
                    </StackPanel>
                </Border>

                <!-- Reset Card -->
                <Border Classes="Card">
                    <StackPanel Spacing="10">
                        <TextBlock Text="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Reset_Title]}" Classes="Subtitle"/>
                        <Button Name="btnClearAll" Content="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_Reset_ClearAll]}" Classes="Btn BtnDanger" Command="{Binding ClearAllStylesCommand}"/>
                    </StackPanel>
                </Border>
                
            </StackPanel>
        </ScrollViewer>
        
        <!-- Save Bar -->
        <Border VerticalAlignment="Bottom" HorizontalAlignment="Center" Margin="0,0,0,18">
            <Button Name="btnSave" Content="{Binding Source={x:Static services:LocalizationManager.Instance}, Path=[Edit_SaveButton]}" Classes="Btn BtnPill" MinWidth="220" Command="{Binding SaveCommand}"/>
        </Border>
        
    </Grid>
</UserControl>
